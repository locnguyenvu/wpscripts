#!/usr/bin/env bash

if [ -z $AWS_PROFILE ]; then
    echo "Please specify AWS_PROFILE"
fi

COMMAND=$1
shift
if [ "$COMMAND" = "ls-group" ]; then
    declare -a AWSCOMMAND
    AWSCOMMAND=( 'aws' 'logs' 'describe-log-groups' )

    while getopts "p:" options; do
        case "${options}" in
            p)
                AWSCOMMAND+=( '--log-group-name-prefix' "${OPTARG}" )
                ;;
            *)
                ;;
        esac
    done

    eval "${AWSCOMMAND[@]}" >| /tmp/.wpscripts-awsl-ls-group

    cat /tmp/.wpscripts-awsl-ls-group | jq ".logGroups[].logGroupName" | sed 's/"//g' | fzf

elif [ "$COMMAND" = "find-event" ]; then
    declare -a AWSCOMMAND
    AWSCOMMAND=( 'aws' 'logs' 'filter-log-events' )
    START_TIME=0

    while getopts "g:p:t:" options; do
        case "${options}" in
            g)
                AWSCOMMAND+=( '--log-group-name' "${OPTARG}" )
                ;;
            p)
                AWSCOMMAND+=( '--filter-pattern' "\"${OPTARG}\"" )
                ;;
            t)
                START_TIME="${OPTARG}"
                ;;
            *)
                ;;
        esac
    done

    if [ $START_TIME -eq 0 ]; then
        AWSCOMMAND+=( '--start-time' $(php -r "echo strtotime('-1 day') * 1000;") )
    else
        AWSCOMMAND+=( '--start-time' $START_TIME )
    fi

    eval "${AWSCOMMAND[@]}" >| /tmp/.wpscripts-awsl-find-event || exit 1
    bat -l json /tmp/.wpscripts-awsl-find-event
fi
